---
title: "Basic Example"
author: "Ruben Cabrera"
date: "2023-07-29"
output: 
  github_document: default
  html_document: default
# always_allow_html: true
# devtools::install_github("kupietz/kableExtra")
# install.packages("xfun", repos=c("http://rstudio.org/_packages", "http://cran.rstudio.com"))
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Basic Example

Adding Covariances between random effects

```{r, message=FALSE, warning=FALSE}
library(nlmixr2)
library(ggplot2)
library(ggforce) # facet_wrap_paginate
library(dplyr) # For filter 
```

## Data

Phenobarbitol data:

This is from a PK study in neonatal infants. They received multiple doses of phenobarbital for seizure prevention.
A data frame with 744 rows and 8 columns

- ID: Infant  ID
- TIME: Time of (hr)
- AMT: Dose in (ug/kg)
- WT: Weight (kg)
- APGR: A 5-minute Apgar score to measure infant health
- DV: The concentration of phenobarbitol in the serum (ug/mL)
- MDV: If the dependent variable (DV) is missing; 0 for observations, 1 for doses
- EVID: Event ID


```{r data}
# ?pheno_sd
head(pheno_sd)
summary(pheno_sd)
str(pheno_sd)
```
```{r}

# Plot data AMT Dose in (ug/kg)
ggplot(filter(pheno_sd,EVID==1), aes(x=TIME, y = AMT, group=factor(ID), color=factor(ID))) + geom_line() + geom_point() + ylim(c(0, 70)) + xlab('Time')

## Plot data DV concentration of phenobarbitol

ggplot(filter(pheno_sd,EVID==0), aes(x=TIME, y = DV, group=factor(ID), color=factor(ID))) + geom_line() + geom_point() + ylim(c(0, 70)) + xlab('Time')

# Could be interesting plot AMT vs DV (using the last data recorded in both axis)

```


```{r, fig.height=10}

# The superposition of doses as vertical black lines on concentration profiles

pAMT <- geom_segment(data=filter(pheno_sd,EVID==1), aes(x=TIME, xend=TIME, y=0, yend=AMT), size=1)

pDV <- geom_point(data=filter(pheno_sd,EVID==0), aes(x=TIME, y=DV,  color=factor(ID)), size=3)

ggplot() + pAMT
ggplot() + pDV

ggplot() + pAMT + pDV + facet_wrap_paginate(ID~., ncol=3, nrow=3, page=1) + theme(legend.position="none") + ylab("Dose and Concentration (mg/L)")

```

## Model


```{r initial}

pheno <- function() {
  ini({
    tcl <- log(0.008) # typical value of clearance
    tv <-  log(0.6)   # typical value of volume
    ## var(eta.cl)
    eta.cl + eta.v ~ c(1, 0.01, 1) ## cov(eta.cl, eta.v), var(eta.v)
                      # interindividual variability on clearance and volume
    add.err <- 0.1    # residual variability
  })
  model({
    cl <- exp(tcl + eta.cl) # individual value of clearance
    v <- exp(tv + eta.v)    # individual value of volume
    ke <- cl / v            # elimination rate constant
    d/dt(A1) = - ke * A1    # model differential equation
    cp = A1 / v             # concentration in plasma
    cp ~ add(add.err)       # define error model
  })
}

```



The fit is performed by the function nlmixr/nlmixr2 specifying the model, data and estimate

```{r fit}
fit <- nlmixr(pheno, pheno_sd, "saem", control=list(print=0), table=list(cwres=TRUE, npde=TRUE))
print(fit)

```


Output description

```{r output}

# Estimation of DV: PRED and IPRED

mydata <- pheno_sd[pheno_sd$EVID==0,]
plot(mydata$DV,fit$PRED)
plot(mydata$DV,fit$IPRED)
plot(mydata$DV,fit$EPRED)

# What is the difference between PRED and IPRED?
  
# eta.ka:
plot(mydata$ID,fit$eta.ka)
plot(mydata$ID,fit$eta.cl)
plot(mydata$ID,fit$eta.v)
plot(mydata$ID,fit$cp)
plot(mydata$DV,fit$cp)
plot(mydata$DV,fit$depot)
plot(mydata$DV,fit$center)   
plot(mydata$DV,fit$ka)
plot(mydata$DV,fit$cl)
plot(mydata$DV,fit$v)
plot(mydata$DV,fit$tad)
plot(mydata$DV,fit$depot)
plot(mydata$DV,fit$dosenum)
```



Plots

```{r plot_model}
library(xpose.nlmixr2)
xpdb = xpose_data_nlmixr(fit)


library(xpose)
plt <- dv_vs_ipred(xpdb)

library(ggPMX)
ctr = pmx_nlmixr(fit)
pmx_plot_dv_ipred(ctr)
```



